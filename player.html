<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Eyeplayer : Control stuff with your webcam" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <style>
      div#instructions {
        text-align: center;
        position: absolute;
      }
      div#videoContainer {
        max-width: 1024px;
        height: 480px;
        position: relative;
      }
      canvas#overlay {
        width: 100%;
        position: absolute;
        transform: rotateY(180deg);
        -webkit-transform:rotateY(180deg); /* Safari and Chrome */
        -moz-transform:rotateY(180deg);
      }
      video {
        width: 100%;
        position: absolute;
      }
      .container {
        overflow: auto;
        overflow-y: hidden;
        width: 100%;
      }
      #episodes a {
        cursor: pointer;
        display: block;
        float: left;
        width: 210px;
        height: 280px;
      }
      #episodes .playing {
        background-color: #ddd;
      }
      #episodes a img { margin: 0px; }
      #episodes a h5, #episodes a p {
        margin: 0px 5px 0px 5px;
      }
      h4 small { font-size: smaller; }
    </style>

    <title>Eyeplayer</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/sidekickstudios/eyeplayer">View on GitHub</a>

          <h1 id="project_title"><a href="/eyeplayer/">Eyeplayer</a></h1>

          <h2 id="project_tagline">Control stuff with your webcam</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/sidekickstudios/eyeplayer/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/sidekickstudios/eyeplayer/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>Demonstration</h3>

        <div id="videoContainer">
          <div id="instructions">
            <h3>You need to let us access your camera! (see above)</h3>
            <p>Instructions go here</p>
          </div>
          <video id="inputVideo" autoplay></video>
          <canvas id="overlay"></canvas>

        </div>
        <div id="mediaPlayer" style="width: 100%; height: 83px;"></div>

        <h4 id="your-face-heading" style="display: none;">Your party face <small>(click to download)</small></h4>
        <div class="container">
          <div id="your-face"></div>
        </div>

        <h4>Pick a show</h4>
        <div class="container">
          <div id="episodes">
          </div>
        </div>


        <h3>Usage example</h3>

        <pre><code>
          ...
        </code></pre>

        <ul>
          <li class="attribution">Record designed by <a href="/joylucktrevor">Trevor Tarczynski</a> from the <a href="http://www.thenounproject.com">Noun Project</a></li>
        </ul>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Eyeplayer maintained by <a href="https://github.com/sidekickstudios">sidekickstudios</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    <script data-main="javascripts/motionPlayer.min.js" src="javascripts/require.js"></script>
    <script type="text/javascript">
      var mediaPlayer;
      var bbcRequireMap = {
        "jquery-1.9":"http://static.bbci.co.uk/frameworks/jquery/0.3.0/sharedmodules/jquery-1.9.1",
        "swfobject-2":"http://static.bbci.co.uk/frameworks/swfobject/0.1.10/sharedmodules/swfobject-2",
        "bump-3":"http://emp.bbci.co.uk/emp/bump-3/bump-3"
      }
      require({ paths: bbcRequireMap, waitSeconds: 30 });
      require(['bump-3', 'motionPlayer', 'howler.min', 'gif'],function ($, motionPlayer, Howler, Gif) {
        var settings = {
          product : 'iplayer',
          playerProfile: 'smp',
          responsive: true,
          autoplay: true,
          ui: { poster: { enabled: false } }
        }
        mediaPlayer = $('#mediaPlayer').player(settings);

        function playEpisode(episode) {
          $('#episodes a').removeClass('playing');
          episode.addClass('playing');
          mediaPlayer.load('http://www.bbc.co.uk/iplayer/playlist/' + episode.data('pid'));
        }

        url = "http://www.bbc.co.uk/radio1/programmes/genres/music/danceandelectronica/player/episodes.json"
        $.ajax({
          dataType: "json",
          url: url,
          success: function(data) {
            data.episodes.forEach(function(episode) {
              var pid = episode.programme.pid;
              var html = '<a data-pid="' + pid + '">' +
                '  <img src="http://ichef.bbci.co.uk/images/ic/192x108/legacy/episode/' + pid + '.jpg?nodefault=true" />' +
                '  <h5>' + episode.programme.programme.title + '</h5>' +
                '  <p>' + episode.programme.title + '</p>' +
                '</a>'
              $('#episodes').append(html);
            });
            $('#episodes').width(data.episodes.length * 211);

            $('#episodes a').click(function() {
              playEpisode($(this));
            })
            playEpisode($("#episodes a:first-child"));
          }
        });

        var video = document.getElementById('inputVideo');
        var canvas = document.getElementById('overlay');
        var motionplayer = new motionPlayer({
          scale: 1/3,
          debug: true
        });
        var ctx = canvas.getContext('2d');

        var sounds = {}, audioFiles = ['bomb', 'klaxon'];
        for (var i=0; i<audioFiles.length; i++) {
          name = audioFiles[i];
          sounds[name] = new Howl({ urls: ["sounds/" + name + ".mp3"] });
        }

        function Recorder() {
          var recordCanvas = document.createElement('canvas');
          var recordCtx = recordCanvas.getContext('2d');
          var gif, isRecording, lastFrameTime, totalTime;
          recordCanvas.width = 160; recordCanvas.height = 120;

          var renderingImg = new Image();
          renderingImg.src = "images/recording.svg";
          renderingImg.angle = 0;

          this.start = function() {
            if (!this.recording() && !this.rendering()) {
              totalTime = 0;
              isRecording = true;
              lastFrameTime = new Date().getTime();
              gif = new GIF({
                workers: 2,
                quality: 10,
                width: recordCanvas.width,
                height: recordCanvas.height
              });
              gif.on('finished', function(blob) {
                var a = document.createElement("a");
                var g = document.createElement("img");
                g.src = URL.createObjectURL(blob);
                var container = document.getElementById("your-face");
                a.appendChild(g);
                a.href = g.src;
                a.download = "your-face.gif";
                container.insertBefore(a, container.firstChild);
                gif = null;

                $('#your-face-heading').show();
                $('#your-face').width($('#your-face a').length * 172);
              });
            }
          }

          this.recording = function() {
            return (isRecording);
          }

          this.rendering = function() {
            return (gif && gif.running);
          }

          this.tick = function(image) {
            if (this.recording() && !this.rendering()) {
              var now = new Date().getTime();
              var timeDiff = now - lastFrameTime;
              recordCtx.drawImage(canvas, 0, 0, recordCanvas.width, recordCanvas.height);
              gif.addFrame(recordCtx, { copy: true, delay: timeDiff });
              lastFrameTime = now;
              totalTime += timeDiff;
            }
            if (totalTime > 3000) {
              this.finish();
            }
          }

          this.finish = function() {
            if (this.recording() && !this.rendering()) {
              isRecording = false;
              gif.render();
            }
          }

          this.draw = function() {
            var r = Math.floor(canvas.width/50);
            var x = canvas.width-r*2, y = canvas.height-r*2;

            if (this.recording()) {
              // draw circle
              ctx.beginPath();
              ctx.arc(x, y, r-5, 0, 2 * Math.PI, false);
              ctx.fillStyle = 'red';
              ctx.fill();
              ctx.lineWidth = 5;
              ctx.strokeStyle = '#ffffff';
              ctx.stroke();

              // draw REC
              ctx.save();
              ctx.translate(x - (r * 1.5), y + r*0.7);
              ctx.scale(-1,1);
              ctx.strokeStyle = "rgba(255,0,0,1)";
              ctx.font = "bold " + r*2 + "px sans-serif";
              ctx.fillText("REC", 0, 0);
              ctx.restore();
            } else if (this.rendering()) {
              ctx.save();
              ctx.translate(x, y);
              ctx.rotate(renderingImg.angle+= Math.PI/20);
              ctx.drawImage(renderingImg, -r, -r, r*2, r*2);
              ctx.restore();
            }
          }



        }
        var recorder = new Recorder();

        function TurnTable() {
          var vinylImg = new Image();
          vinylImg.src = "images/vinyl.svg";
          var vinylAngle = 0, vinylAngleDiff = Math.PI/10;

          var sounds = {}, audioFiles = ['rewind', 'fastforward', 'scratch'];
          for (var i=0; i<audioFiles.length; i++) {
            name = audioFiles[i];
            sounds[name] = new Howl({
              urls: ["sounds/" + name + ".mp3"],
              onend: function() { reset(); }
            });
          }

          function reset() {
            vinylAngleDiff = Math.PI/10;
            mediaPlayer.play();
          }

          this.fastforward = function() {
            if (!this.status()) {
              sounds['fastforward'].play();
              var time = mediaPlayer.currentTime();
              mediaPlayer.pause();
              mediaPlayer.currentTime(time + 30);
              vinylAngleDiff = Math.PI / 5;
            }
          }

          this.rewind = function() {
            if (!this.status()) {
              sounds['rewind'].play();
              var time = mediaPlayer.currentTime();
              mediaPlayer.pause();
              mediaPlayer.currentTime(time - 30);
              vinylAngleDiff = - Math.PI / 5;
            }
          }

          this.scratch = function() {
            if (!this.status()) {
              sounds['scratch'].play();
              vinylAngleDiff = 0;
              mediaPlayer.pause();
            }
          }

          function drawText(text) {
            ctx.save();
            ctx.translate(2*(canvas.width/3), canvas.height/2);
            ctx.scale(-1,1);
            ctx.strokeStyle = "rgba(255,255,255,1)";
            ctx.font="40px Georgia";
            ctx.fillText(text, 0, 0);
            ctx.restore();
          }

          this.status = function() {
            var s = null;
            for (var i=0; i < audioFiles.length; i++) {
              var name = audioFiles[i];
              if (sounds[name].pos() > 0) {
                s = name;
                break;
              }
            }
            return s;
          }

          this.draw = function() {
            var w = canvas.width / 2;
            ctx.save();
            ctx.translate(w, -w/4);
            ctx.rotate(vinylAngle);
            ctx.drawImage(vinylImg, -w/2, -w/2, w, w);
            ctx.restore();
            vinylAngle += vinylAngleDiff;

            var s = this.status();
            var text = {
              rewind: "PULL UP!",
              fastforward: "GO FORWARD",
              scratch: "SCRATCH"
            }[s];
            if (text) { drawText(text) };
          }
        }
        var turnTable = new TurnTable();

        var klaxonImg = new Image(), bombImg = new Image();
        bombImg.src = "images/bomb.svg";
        klaxonImg.src = "images/klaxon.png";

        motionplayer.init(video, canvas);
        motionplayer.start();

        function playSound(name) {
          if (sounds[name].pos() === 0) {
            sounds[name].play();
          } else if (sounds[name].pos() < 0.5) {
            sounds[name].pos(0);
          }
        }
        function playSoundIfPaused(name) {
          if (sounds[name].pos() === 0) {
            sounds[name].play();
            return true;
          } else {
            return false;
          }
        }

        function drawActionButton(img, sound, x, y, w) {
          if (sound.pos() > 0) {
            var scale = (0.75 + (Math.random()/4));
            var size = scale * w;
            var offset = (w - size)/2;
            ctx.drawImage(img, x+offset, y+offset, size, size);
          } else {
            ctx.drawImage(img, x, y, w, w);
          }
        }

        function drawMotionCam(image, regions, w) {
          var mX = 0,
              mY = 2 * (canvas.height / 3),
              mW = canvas.width / 3,
              mH = canvas.height / 3,
              rW = w / 3;

          ctx.drawImage(image, mX, mY, mW, mH);

          var border = rW/10;
          ctx.lineWidth = 1;
          ctx.strokeStyle = "rgba(255,255,255,0.8)";
          ctx.strokeRect(mX+border, mY+border, mW-(border*2), rW-border);

          for (var i = 0; i < regions.length; i++) {
            if (i !== 1 && i !== 6 && regions[i] > 0) {
              ctx.fillStyle = "rgba(255,255,255," + (regions[i]/100) + ")";
              ctx.fillRect(mX+i*rW, mY, rW, rW);
            }
          }
        }

        document.addEventListener('motionEvent', function(event) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          recorder.tick(canvas);

          var w = canvas.width / 8;
          drawMotionCam(event.image, event.regions, w);
          drawActionButton(bombImg, sounds['bomb'], 0, 0, w);
          drawActionButton(klaxonImg, sounds['klaxon'], canvas.width-w, 0, w);

          turnTable.draw();
          recorder.draw();

          var regions = event.regions;
          if (regions[0] > 0) {
            playSound('bomb');
            recorder.start();
          }
          if (regions[7] > 0) {
            playSound('klaxon');
            recorder.start();
          }

          var left = regions[2] + regions[3],
            right = regions[4] + regions[5];
          if (left > 0 && right > 0) {
            var diff = Math.abs(left - right);
            if (diff < 30) {
              turnTable.scratch();
            } else if (left > right) {
              turnTable.rewind();
            } else {
              turnTable.fastforward();
            }
          }
        });
      });
    </script>
  </body>
</html>
