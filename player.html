<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Eyeplayer : Control stuff with your webcam" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <style>
      div#videoContainer {
        max-width: 1024px;
        height: 480px;
        position: relative;
      }
      canvas#overlay {
        width: 100%;
        position: absolute;
        transform: rotateY(180deg);
        -webkit-transform:rotateY(180deg); /* Safari and Chrome */
        -moz-transform:rotateY(180deg);
      }
      video {
        width: 100%;
        position: absolute;
      }
    </style>

    <title>Eyeplayer</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/sidekickstudios/eyeplayer">View on GitHub</a>

          <h1 id="project_title">Eyeplayer</h1>
          <h2 id="project_tagline">Control stuff with your webcam</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/sidekickstudios/eyeplayer/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/sidekickstudios/eyeplayer/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>Demonstration</h3>

        <div id="mediaPlayer" style="width: 100%; height: 200px;"></div>
        <div id="videoContainer">
          <video id="inputVideo" autoplay></video>
          <canvas id="overlay"></canvas>
        </div>

        <h3>Usage example</h3>

        <pre><code>
          ...
        </code></pre>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Eyeplayer maintained by <a href="https://github.com/sidekickstudios">sidekickstudios</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    <script data-main="javascripts/motionPlayer.min.js" src="javascripts/require.js"></script>
    <script type="text/javascript">
      var mediaPlayer;
      var bbcRequireMap = {
        "jquery-1.9":"http://static.bbci.co.uk/frameworks/jquery/0.3.0/sharedmodules/jquery-1.9.1",
        "swfobject-2":"http://static.bbci.co.uk/frameworks/swfobject/0.1.10/sharedmodules/swfobject-2",
        "bump-3":"http://emp.bbci.co.uk/emp/bump-3/bump-3"
      }
      require({ paths: bbcRequireMap, waitSeconds: 30 });
      require(['bump-3'],function ($) {
          var settings = {
             product : 'iplayer',
             playerProfile: 'smp',
             responsive: true,
             autoplay: true
          }
          mediaPlayer = $('#mediaPlayer').player(settings);
          mediaPlayer.load('http://www.bbc.co.uk/iplayer/playlist/p01pp3y6');
      });

      require(['motionPlayer'], function(motionPlayer) {
        var video = document.getElementById('inputVideo');
        var canvas = document.getElementById('overlay');
        var motionplayer = new motionPlayer({ debug: true });
        var ctx = canvas.getContext('2d');

        var sounds = {}, audioFiles = ['klaxon', 'bomb', 'wob', 'glass', 'rewind'];
        for (var i=0; i<audioFiles.length; i++) {
          name = audioFiles[i];
          sounds[name] = new Audio();
          sounds[name].src = "sounds/" + name + ".mp3";
        }

        motionplayer.init(video, canvas);
        motionplayer.start();

        motionplayer.setFilter(function(image) {
          data = image.data;
          for (var i=0; i<data.length; i+=4) {
            data[i+3] = 50;
          }
        });

        function playSoundIfPaused(name) {
          if (sounds[name].paused) {
            sounds[name].play();
          }
        }
        function rewind() {
          if (sounds['rewind'].paused) {
            var time = mediaPlayer.currentTime();
            mediaPlayer.currentTime(time - 30);
            sounds['rewind'].play();
          }
        }

        document.addEventListener('motionEvent', function(event) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          ctx.drawImage(event.image, 0, 0, canvas.width, canvas.height);

          for (var i=0; i<event.regions.length; i++) {
            if (event.regions[i] > 0) {
              ctx.save();
              ctx.translate(i*canvas.width/8, 10);
              ctx.scale(-1,1);
              ctx.font="10px Georgia";
              ctx.fillText(Math.floor(event.regions[i]), 0, 0);
              ctx.restore();

              if (i===0) { playSoundIfPaused('bomb'); }
              if (i===3 || i===4) { rewind(); }
              if (i===7) { playSoundIfPaused('glass'); }
            }
          }
        });
      });
    </script>
  </body>
</html>
