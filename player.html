<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Eyeplayer : Control stuff with your webcam" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <style>
      div#videoContainer {
        max-width: 1024px;
        height: 480px;
        position: relative;
      }
      canvas#overlay {
        width: 100%;
        position: absolute;
        transform: rotateY(180deg);
        -webkit-transform:rotateY(180deg); /* Safari and Chrome */
        -moz-transform:rotateY(180deg);
      }
      video {
        width: 100%;
        position: absolute;
      }
      .container {
        overflow: auto;
        overflow-y: hidden;
        width: 100%;
      }
      #episodes {
        /*height: 280px;*/
      }
      #episodes a {
        cursor: pointer;
        display: block;
        float: left;
        width: 210px;
        height: 280px;
      }
      #episodes .playing {
        background-color: #ddd;
      }
      #episodes a img { margin: 0px; }
      #episodes a h5, #episodes a p {
        margin: 0px 5px 0px 5px;
      }
      #your-face a:hover {

      }
    </style>

    <title>Eyeplayer</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/sidekickstudios/eyeplayer">View on GitHub</a>

          <h1 id="project_title"><a href="/eyeplayer/">Eyeplayer</a></h1>

          <h2 id="project_tagline">Control stuff with your webcam</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/sidekickstudios/eyeplayer/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/sidekickstudios/eyeplayer/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>Demonstration</h3>

        <div id="videoContainer">
          <video id="inputVideo" autoplay></video>
          <canvas id="overlay"></canvas>
        </div>
        <div id="mediaPlayer" style="width: 100%; height: 83px;"></div>

        <div id="your-face" class="container"></div>

        <h4>Pick a show</h4>
        <div class="container">
          <div id="episodes">
          </div>
        </div>


        <h3>Usage example</h3>

        <pre><code>
          ...
        </code></pre>

        <ul>
          <li class="attribution">Record designed by <a href="/joylucktrevor">Trevor Tarczynski</a> from the <a href="http://www.thenounproject.com">Noun Project</a></li>
        </ul>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Eyeplayer maintained by <a href="https://github.com/sidekickstudios">sidekickstudios</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    <script data-main="javascripts/motionPlayer.min.js" src="javascripts/require.js"></script>
    <script type="text/javascript">
      var mediaPlayer;
      var bbcRequireMap = {
        "jquery-1.9":"http://static.bbci.co.uk/frameworks/jquery/0.3.0/sharedmodules/jquery-1.9.1",
        "swfobject-2":"http://static.bbci.co.uk/frameworks/swfobject/0.1.10/sharedmodules/swfobject-2",
        "bump-3":"http://emp.bbci.co.uk/emp/bump-3/bump-3"
      }
      require({ paths: bbcRequireMap, waitSeconds: 30 });
      require(['bump-3'],function ($) {
        var settings = {
          product : 'iplayer',
          playerProfile: 'smp',
          responsive: true,
          autoplay: true,
          ui: { poster: { enabled: false } }
        }
        mediaPlayer = $('#mediaPlayer').player(settings);

        function playEpisode(episode) {
          $('#episodes a').removeClass('playing');
          episode.addClass('playing');
          mediaPlayer.load('http://www.bbc.co.uk/iplayer/playlist/' + episode.data('pid'));
        }

        url = "http://www.bbc.co.uk/radio1/programmes/genres/music/danceandelectronica/player/episodes.json"
        $.ajax({
          dataType: "json",
          url: url,
          success: function(data) {
            data.episodes.forEach(function(episode) {
              var pid = episode.programme.pid;
              var html = '<a data-pid="' + pid + '">' +
                '  <img src="http://ichef.bbci.co.uk/images/ic/192x108/legacy/episode/' + pid + '.jpg?nodefault=true" />' +
                '  <h5>' + episode.programme.programme.title + '</h5>' +
                '  <p>' + episode.programme.title + '</p>' +
                '</a>'
              $('#episodes').append(html);
            });
            $('#episodes').width(data.episodes.length * 211);

            $('#episodes a').click(function() {
              playEpisode($(this));
            })
            playEpisode($("#episodes a:first-child"));
          }
        });
      });

      require(['motionPlayer', 'howler.min', 'gif'], function(motionPlayer, Howler, Gif) {
        var video = document.getElementById('inputVideo');
        var canvas = document.getElementById('overlay');
        var motionplayer = new motionPlayer({ debug: true });
        var ctx = canvas.getContext('2d');

        var recordCanvas = document.createElement('canvas');
        recordCanvas.width = 160; recordCanvas.height = 120;
        var recordCtx = recordCanvas.getContext('2d');
        var gif, recordGif, lastFrameTime;

        var sounds = {}, audioFiles = ['klaxon'];
        for (var i=0; i<audioFiles.length; i++) {
          name = audioFiles[i];
          sounds[name] = new Howl({ urls: ["sounds/" + name + ".mp3"] });
        }
        sounds['rewind'] = new Howl({
          urls: ["sounds/rewind.mp3"],
          onend: function() {
            vinylAngleDiff = Math.PI/10;
            mediaPlayer.play();
          }
        });
        sounds['fastforward'] = new Howl({
          urls: ["sounds/fastforward.mp3"],
          onend: function() {
            vinylAngleDiff = Math.PI/10;
            mediaPlayer.play();
          }
        });
        sounds['bomb'] = new Howl({
          urls: ["sounds/bomb.mp3"],
          onend: function() {
            console.log("finished bomb");
            gif.render();
            recordGif = false;
          }
        });

        var klaxonImg = new Image(), bombImg = new Image();
        bombImg.src = "images/bomb.svg";
        klaxonImg.src = "images/klaxon.png";
        var vinylImg = new Image();
        vinylImg.src = "images/vinyl.svg";

        motionplayer.init(video, canvas);
        motionplayer.start();

        motionplayer.setFilter(function(image) {
          data = image.data;
          for (var i=0; i<data.length; i+=4) {
            data[i+3] = 50;
          }
        });

        var vinylAngle = 0, vinylAngleDiff = Math.PI/10;
        function drawVinyl() {
          var w = canvas.width / 2;
          ctx.save();
          ctx.translate(w, -w/4);
          ctx.rotate(vinylAngle);
          ctx.drawImage(vinylImg, -w/2, -w/2, w, w);
          ctx.restore();
          vinylAngle += vinylAngleDiff;
        }

        function playSound(name) {
          if (sounds[name].pos() === 0) {
            sounds[name].play();
          } else {
            sounds[name].pos(0);
          }
        }
        function playSoundIfPaused(name) {
          if (sounds[name].pos() === 0) {
            sounds[name].play();
            return true;
          } else {
            return false;
          }
        }

        document.addEventListener('motionEvent', function(event) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          ctx.drawImage(event.image, 0, 0, canvas.width, canvas.height);

          var w = canvas.width / 8;
          ctx.drawImage(bombImg, 0, 0, w, w);

          if (sounds['klaxon'].pos() > 0) {
            var scale = (0.75 + (Math.random()/4));
            var size = scale * w;
            var offset = (w - size)/2;
            ctx.drawImage(klaxonImg, canvas.width-w+offset, offset, size, size);
          } else {
            ctx.drawImage(klaxonImg, canvas.width-w, 0, w, w);
          }

          // ctx.strokeRect(w*3, 0, w*2, w);

          drawVinyl();

          if (recordGif) {
            var now = new Date().getTime();
            recordCtx.drawImage(canvas, 0, 0, recordCanvas.width, recordCanvas.height);
            gif.addFrame(recordCtx, { copy: true, delay: now-lastFrameTime });
            lastFrameTime = now;
          }

          for (var i=0; i<event.regions.length; i++) {
            if (event.regions[i] > 0) {
              ctx.save();
              ctx.translate(i*canvas.width/8, 10);
              ctx.scale(-1,1);
              ctx.font="10px Georgia";
              ctx.fillText(Math.floor(event.regions[i]), 0, 0);
              ctx.restore();

              if (i===0) {
                if (playSoundIfPaused('bomb')) {
                  recordGif = true;
                  lastFrameTime = new Date().getTime();
                  gif = new GIF({ workers: 2, quality: 10, width: recordCanvas.width, height: recordCanvas.height });
                  gif.on('finished', function(blob) {
                    var a = document.createElement("a");
                    var g = document.createElement("img");
                    g.src = URL.createObjectURL(blob);
                    var container = document.getElementById("your-face");
                    a.appendChild(g);
                    a.href = g.src;
                    a.download = "your-face.gif";
                    container.insertBefore(a, container.firstChild);
                  });
                };
              }
              if (i===7) { playSound('klaxon'); }
            }
          }

          var regions = event.regions;
          if (regions[3] > 0 && regions[4] > 0) {
            if (regions[3] > regions[4]) {
              if ((sounds['fastforward'].pos() === 0) && playSoundIfPaused('rewind')) {
                var time = mediaPlayer.currentTime();
                mediaPlayer.pause();
                mediaPlayer.currentTime(time - 30);
                vinylAngleDiff = - Math.PI / 5;
              }
            } else {
              if ((sounds['rewind'].pos() === 0) && playSoundIfPaused('fastforward')) {
                var time = mediaPlayer.currentTime();
                mediaPlayer.pause();
                mediaPlayer.currentTime(time + 30);
                vinylAngleDiff = Math.PI / 5;
              }
            }
          }
        });
      });
    </script>
  </body>
</html>
